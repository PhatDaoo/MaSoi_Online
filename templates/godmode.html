<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>WEREWOLF: THE GAME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CORE */
        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: #555 #111; user-select: none; }
        body { 
            background: #050505; color: #e0e0e0; font-family: 'VT323', monospace;
            font-size: 20px; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* HEADER */
        .top-bar { 
            background: #111; border-bottom: 2px solid #333; padding: 0 20px; 
            display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0;
        }
        .title { color: #e94560; font-size: 28px; letter-spacing: 2px; }
        .room-info { font-size: 24px; color: #fcd34d; cursor: pointer; border: 1px dashed #555; padding: 0 10px; }
        
        /* LAYOUT MAIN */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR LEFT & RIGHT */
        .sidebar { width: 250px; background: #080808; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-right { width: 300px; border-left: 1px solid #333; border-right: none; background: #0a0a0a; }
        
        .panel-header { background: #151515; padding: 5px 10px; font-size: 20px; color: #888; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        
        /* PLAYER LIST */
        #player-list { flex: 1; overflow-y: auto; padding: 5px; }
        .player-row { display: flex; justify-content: space-between; padding: 3px 10px; background: #111; margin-bottom: 2px; font-size: 18px; align-items: center; }
        .p-alive { color: #4caf50; } .p-dead { color: #666; text-decoration: line-through; }
        .kick-x { color: #d00; cursor: pointer; margin-left: 5px; }

        /* --- MAIN AREA (3 ROWS SLIDER) --- */
        .main-area { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }
        
        .faction-row {
            flex: 1; display: flex; flex-direction: row; border-bottom: 1px solid #222;
            position: relative; overflow: hidden;
        }
        .faction-label {
            writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);
            width: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; letter-spacing: 3px; border-right: 1px solid #333;
            flex-shrink: 0; z-index: 20; background: #050505;
        }
        .lbl-villager { color: #4caf50; border-right-color: #1b5e20; }
        .lbl-wolf { color: #ff5252; border-right-color: #b71c1c; }
        .lbl-neutral { color: #e040fb; border-right-color: #4a148c; }

        /* SLIDER CONTAINER */
        .slider-wrapper {
            flex: 1; display: flex; align-items: center; overflow-x: auto; 
            scroll-snap-type: x mandatory; padding: 0 40%;
            gap: 20px; position: relative; z-index: 10;
        }
        .slider-wrapper::-webkit-scrollbar { height: 8px; }
        .slider-wrapper::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* --- M≈®I T√äN CH·ªà TH·ªä --- */
        .center-marker {
            position: absolute; 
            left: calc(50% - 70px); 
            top: 0; bottom: 0;
            width: 150px; transform: translateX(-50%);
            pointer-events: none;
            z-index: 5;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 5px 0;
        }
        .arrow-down {
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 15px solid #fcd34d; filter: drop-shadow(0 0 5px #fcd34d);
            animation: bounceDown 1.5s infinite;
        }
        .arrow-up {
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-bottom: 15px solid #fcd34d; filter: drop-shadow(0 0 5px #fcd34d);
            animation: bounceUp 1.5s infinite;
        }
        @keyframes bounceDown { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes bounceUp { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* CARD STYLE */
        .card {
            scroll-snap-align: center;
            width: 140px; height: 200px; 
            background: #111; border: 2px solid #444; border-radius: 12px;
            flex-shrink: 0; position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0.3; transform: scale(0.8); filter: grayscale(80%);
            cursor: pointer; overflow: hidden; /* Gi·ªØ bo g√≥c ·∫£nh */
        }
        
        .card.active {
            opacity: 1; transform: scale(1.15); filter: grayscale(0%);
            border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.1);
            z-index: 15;
        }
        
        .card-img { 
            width: 100%; height: 100%; object-fit: cover; image-rendering: auto; 
        }
        
        /* --- BADGE S·ªê L∆Ø·ª¢NG (ƒê√É S·ª¨A) --- */
        .qty-badge {
            position: absolute; 
            top: 5px; right: 5px; /* ƒê∆∞a v√†o trong g√≥c 5px ƒë·ªÉ kh√¥ng b·ªã c·∫Øt */
            background: #e94560; color: #fff; 
            width: 30px; height: 30px;
            border-radius: 50%; /* Tr√≤n xoe */
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold;
            border: 2px solid #ffffff; /* Th√™m vi·ªÅn tr·∫Øng ƒë·ªÉ t√°ch bi·ªát v·ªõi ·∫£nh */
            box-shadow: 0 2px 4px rgba(0,0,0,0.8); /* ƒê·ªï b√≥ng nh·∫π */
            display: none; z-index: 20;
        }

        /* ZOOM BUTTON */
        .zoom-btn {
            position: absolute; bottom: 5px; right: 5px;
            width: 30px; height: 30px; background: rgba(0,0,0,0.7);
            border: 1px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 16px; z-index: 25;
            opacity: 0; transition: opacity 0.2s;
        }
        .card:hover .zoom-btn, .card.active .zoom-btn { opacity: 1; }
        .zoom-btn:hover { background: #e94560; transform: scale(1.1); }

        /* CARD MODAL */
        #card-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; align-items: center; justify-content: center; flex-direction: column;
            animation: fadeIn 0.2s;
        }
        .modal-content {
            position: relative; width: 340px; height: 500px;
            background: transparent; perspective: 1000px;
        }
        .modal-img {
            width: 100%; height: 100%; object-fit: contain;
            border-radius: 15px; box-shadow: 0 0 30px rgba(255,255,255,0.2);
            border: 2px solid #555; background: #000;
        }
        .modal-close-hint {
            margin-top: 20px; color: #888; font-size: 24px; animation: blink 1s infinite;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* CONTROL PANEL */
        .row-control {
            width: 180px; background: #0e0e0e; border-left: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; flex-shrink: 0; z-index: 20;
        }
        .ctrl-role-name { color: #fcd34d; font-size: 22px; text-align: center; margin-bottom: 5px; line-height: 1.1; }
        .ctrl-role-desc { color: #777; font-size: 16px; text-align: center; margin-bottom: 10px; height: 40px; overflow: hidden; }
        
        .ctrl-inputs { display: flex; align-items: center; gap: 5px; }
        .btn-qty { 
            width: 35px; height: 35px; background: #333; color: #fff; border: 1px solid #555; 
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-qty:hover { background: #555; }
        .inp-qty { 
            width: 40px; height: 35px; background: #000; border: 1px solid #444; 
            color: #fff; text-align: center; font-family: inherit; font-size: 24px; 
        }

        /* BOTTOM BAR */
        .control-bar { 
            height: 60px; background: #111; border-top: 2px solid #333; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .btn-start { 
            background: #2e7d32; color: white; padding: 5px 30px; font-size: 24px; 
            border: 2px solid #1b5e20; cursor: pointer; font-family: inherit; 
        }
        .btn-skip { background: #ff8f00; color: #000; padding: 5px 20px; font-size: 22px; border: 2px solid #e65100; cursor: pointer; font-family: inherit; }

        /* LOG & CHAT */
        #log-console { flex: 1; overflow-y: auto; padding: 10px; font-size: 16px; color: #ccc; }
        .chat-controls { display: flex; gap: 5px; padding: 10px; border-top: 1px solid #333; background: #111; }
        #admin-msg-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 5px; font-family: inherit; }
    </style>
</head>
<body>

    <div id="card-modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()"> 
            <img id="modal-img-display" class="modal-img" src="">
        </div>
        <div class="modal-close-hint">CH·∫†M RA NGO√ÄI ƒê·ªÇ ƒê√ìNG</div>
    </div>

    <div class="top-bar">
        <div class="title">WEREWOLF:THE GAME <span style="font-size:16px; color:#666">dev by qhatsdaoo</span></div>
        <div class="room-info" onclick="copyRoomID()">ID: <span id="room-id-display">...</span></div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="panel-header">
                <span>PLAYERS</span> <span id="p-count">0</span>
            </div>
            <div id="player-list"></div>
        </div>

        <div class="main-area">
            
            <div class="faction-row">
                <div class="faction-label lbl-villager">D√ÇN</div>
                <div class="center-marker"><div class="arrow-down"></div><div class="arrow-up"></div></div>
                <div class="slider-wrapper" id="slider-villager"></div>
                <div class="row-control" id="ctrl-villager"><div style="color:#444">...</div></div>
            </div>

            <div class="faction-row">
                <div class="faction-label lbl-wolf">S√ìI</div>
                <div class="center-marker"><div class="arrow-down"></div><div class="arrow-up"></div></div>
                <div class="slider-wrapper" id="slider-wolf"></div>
                <div class="row-control" id="ctrl-wolf"><div style="color:#444">...</div></div>
            </div>

            <div class="faction-row">
                <div class="faction-label lbl-neutral">PHE 3</div>
                <div class="center-marker"><div class="arrow-down"></div><div class="arrow-up"></div></div>
                <div class="slider-wrapper" id="slider-neutral"></div>
                <div class="row-control" id="ctrl-neutral"><div style="color:#444">...</div></div>
            </div>
        </div>

        <div class="sidebar sidebar-right">
            <div class="panel-header">LOG H·ªÜ TH·ªêNG</div>
            <div id="log-console"></div>
            <div class="chat-controls">
                <input type="text" id="admin-msg-input" placeholder="Nh·∫Øn c·∫£ l√†ng..." onkeydown="if(event.key==='Enter') sendAdminChat()">
                <button onclick="sendAdminChat()" style="cursor:pointer">G·ª¨I</button>
            </div>
        </div>
    </div>

    <div class="control-bar">
        <div class="counter-box" style="font-size:24px; color:#aaa">
            ƒê√É CH·ªåN: <span id="total-roles" style="color:#fff; font-weight:bold">0</span> / <span id="total-players" style="color:#fff">0</span>
        </div>
        <div style="display:flex; gap:10px">
            <button class="btn-skip" onclick="endDiscuss()">STOP TALK</button>
            <button id="btn-start" class="btn-start" onclick="startGame()">B·∫ÆT ƒê·∫¶U GAME</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myRoomId = null;
        let GLOBAL_CONFIG = {};
        let SELECTED_COUNTS = {}; 
        let ACTIVE_ROLES = { villager: null, wolf: null, neutral: null };

        socket.emit('create_room'); 

        socket.on('room_created', data => {
            myRoomId = data.room_id;
            GLOBAL_CONFIG = data.roles_config;
            document.getElementById('room-id-display').innerText = myRoomId;
            renderAllSliders();
            updateTotalCounter();
        });

        // --- MODAL LOGIC ---
        function viewCard(rID) {
            const info = GLOBAL_CONFIG[rID];
            if(!info) return;
            const modal = document.getElementById('card-modal');
            const img = document.getElementById('modal-img-display');
            img.src = '/static/assets/' + info.img;
            modal.style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('card-modal').style.display = 'none';
        }

        // --- RENDER SLIDERS ---
        function renderAllSliders() {
            let groups = { villager: [], wolf: [], neutral: [] };
            for (const [rID, info] of Object.entries(GLOBAL_CONFIG)) {
                if(info.team === 'wolf') groups.wolf.push(rID);
                else if(info.team === 'neutral') groups.neutral.push(rID);
                else groups.villager.push(rID);
            }
            renderSlider('villager', groups.villager, "ctrl-villager");
            renderSlider('wolf', groups.wolf, "ctrl-wolf");
            renderSlider('neutral', groups.neutral, "ctrl-neutral");
        }

        function renderSlider(groupName, roleIDs, ctrlId) {
            const container = document.getElementById('slider-' + groupName);
            container.innerHTML = '';
            
            roleIDs.forEach(rID => {
                const info = GLOBAL_CONFIG[rID];
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${rID}`;
                
                card.onclick = () => {
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    setActiveRole(groupName, rID, ctrlId);
                };

                const badge = document.createElement('div');
                badge.className = 'qty-badge';
                badge.id = `badge-${rID}`;
                badge.innerText = SELECTED_COUNTS[rID] || 0;
                if(SELECTED_COUNTS[rID] > 0) badge.style.display = 'flex';

                const zoomBtn = document.createElement('div');
                zoomBtn.className = 'zoom-btn';
                zoomBtn.innerHTML = 'üîç';
                zoomBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    viewCard(rID);
                };

                card.innerHTML = `<img src="/static/assets/${info.img}" class="card-img">`;
                card.appendChild(badge);
                card.appendChild(zoomBtn);
                container.appendChild(card);
            });

            container.addEventListener('scroll', () => {
                detectActiveCard(container, roleIDs, groupName, ctrlId);
            });

            if(roleIDs.length > 0) {
                setTimeout(() => { setActiveRole(groupName, roleIDs[0], ctrlId); }, 500);
            }
        }

        function detectActiveCard(container, roleIDs, groupName, ctrlId) {
            const center = container.scrollLeft + (container.offsetWidth / 2);
            let closest = null;
            let minDist = Infinity;
            roleIDs.forEach(rID => {
                const el = document.getElementById(`card-${rID}`);
                const elCenter = el.offsetLeft + (el.offsetWidth / 2);
                const dist = Math.abs(center - elCenter);
                if(dist < minDist) { minDist = dist; closest = rID; }
            });
            if(closest && ACTIVE_ROLES[groupName] !== closest) {
                setActiveRole(groupName, closest, ctrlId);
            }
        }

        function setActiveRole(groupName, rID, ctrlId) {
            ACTIVE_ROLES[groupName] = rID;
            const container = document.getElementById('slider-' + groupName);
            Array.from(container.children).forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`card-${rID}`);
            if(activeCard) activeCard.classList.add('active');
            renderControlPanel(ctrlId, rID);
        }

        function renderControlPanel(ctrlId, rID) {
            const panel = document.getElementById(ctrlId);
            const info = GLOBAL_CONFIG[rID];
            const count = SELECTED_COUNTS[rID] || 0;
            panel.innerHTML = `
                <div class="ctrl-role-name">${info.name}</div>
                <div class="ctrl-role-desc">${info.desc}</div>
                <div class="ctrl-inputs">
                    <div class="btn-qty" onclick="changeQty('${rID}', -1)">-</div>
                    <input class="inp-qty" id="inp-${rID}" value="${count}" readonly>
                    <div class="btn-qty" onclick="changeQty('${rID}', 1)">+</div>
                </div>
            `;
        }

        function changeQty(rID, delta) {
            let current = SELECTED_COUNTS[rID] || 0;
            let newVal = current + delta;
            if(newVal < 0) newVal = 0;
            SELECTED_COUNTS[rID] = newVal;
            const inp = document.getElementById(`inp-${rID}`);
            if(inp) inp.value = newVal;
            const badge = document.getElementById(`badge-${rID}`);
            if(badge) {
                badge.innerText = newVal;
                badge.style.display = newVal > 0 ? 'flex' : 'none';
            }
            updateTotalCounter();
        }

        function updateTotalCounter() {
            let total = 0;
            for(let key in SELECTED_COUNTS) total += SELECTED_COUNTS[key];
            const pCount = parseInt(document.getElementById('p-count').innerText) || 0;
            const txt = document.getElementById('total-roles');
            txt.innerText = total;
            txt.style.color = (total === pCount && total > 0) ? '#4caf50' : '#ff5252';
            document.getElementById('total-players').innerText = pCount;
        }

        socket.on('admin_update', data => { renderPlayerList(data); });
        function renderPlayerList(data) {
            const list = document.getElementById('player-list');
            document.getElementById('p-count').innerText = data.players.length;
            list.innerHTML = '';
            data.players.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-row';
                let statusClass = p.alive ? 'p-alive' : 'p-dead';
                div.innerHTML = `
                    <span class="${statusClass}">${p.name}</span>
                    <div>
                        ${p.alive ? '‚ù§Ô∏è' : 'üíÄ'} 
                        ${p.alive ? `<span class="kick-x" onclick="kick('${p.sid}')">üö´</span>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
            updateTotalCounter();
            const btnStart = document.getElementById('btn-start');
            if(data.started) {
                btnStart.innerText = "GAME ƒêANG CH·∫†Y...";
                btnStart.disabled = true;
                btnStart.style.opacity = "0.5";
            } else {
                btnStart.innerText = "B·∫ÆT ƒê·∫¶U GAME";
                btnStart.disabled = false;
                btnStart.style.opacity = "1";
            }
        }
        socket.on('server_log', data => {
            const box = document.getElementById('log-console');
            let time = new Date().toLocaleTimeString('vi-VN', {hour12:false});
            box.innerHTML += `<div><span style="color:#555">[${time}]</span> ${data.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        });
        function copyRoomID() { navigator.clipboard.writeText(myRoomId); alert("ƒê√£ copy ID!"); }
        function sendAdminChat() {
            const inp = document.getElementById('admin-msg-input');
            const msg = inp.value.trim();
            if (msg && myRoomId) {
                socket.emit('admin_chat_msg', {room_id: myRoomId, msg: msg});
                inp.value = ''; 
            }
        }
        function startGame() {
            let total = parseInt(document.getElementById('total-roles').innerText);
            let players = parseInt(document.getElementById('total-players').innerText);
            let finalRoles = {};
            for(let [key, val] of Object.entries(SELECTED_COUNTS)) {
                if(val > 0) finalRoles[key] = val;
            }
            if(total != players) {
                if(!confirm(`‚ö†Ô∏è L·ªách s·ªë l∆∞·ª£ng: ${total} Role / ${players} Ng∆∞·ªùi.\nServer s·∫Ω t·ª± ƒë·ªông b√π/c·∫Øt. Ti·∫øp t·ª•c?`)) return;
            }
            socket.emit('admin_start_game', {room_id: myRoomId, roles: finalRoles});
        }
        function endDiscuss() { socket.emit('admin_end_discussion', {room_id: myRoomId}); }
        function kick(sid) { if(confirm("Kick ng∆∞·ªùi n√†y?")) socket.emit('admin_kick', {room_id: myRoomId, sid: sid}); }
    </script>
</body>
</html>