<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MA S√ìI - GOD MODE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CORE */
        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: #444 #111; }
        body { 
            background: #050505; color: #e0e0e0; font-family: 'VT323', monospace;
            font-size: 20px;
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* HEADER */
        .top-bar { 
            background: #111; border-bottom: 2px solid #333; padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; height: 60px;
        }
        .title { color: #e94560; font-size: 32px; font-weight: normal; letter-spacing: 2px; }
        .room-info { font-size: 28px; color: #fcd34d; cursor: pointer; border: 2px dashed #555; padding: 0 15px; }
        .room-info:hover { background: #222; border-color: #fff; }

        /* LAYOUT */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: #0a0a0a; border-right: 2px solid #333; display: flex; flex-direction: column; }
        .sidebar-right { width: 320px; border-left: 2px solid #333; border-right: none; }
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #0e0e0e; overflow-y: auto; }
        
        .panel-header { 
            background: #1a1a1a; padding: 8px 10px; font-size: 22px; color: #888; 
            border-bottom: 2px solid #333; display: flex; justify-content: space-between;
        }
        
        /* LISTS */
        #player-list { flex: 1; overflow-y: auto; padding: 5px; }
        .player-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 5px 10px; margin-bottom: 2px; background: #111; font-size: 22px;
        }
        .player-row:hover { background: #222; }
        .p-alive { color: #4caf50; }
        .p-dead { color: #666; text-decoration: line-through; }
        .kick-x { color: #d00; cursor: pointer; font-weight: bold; padding: 0 5px; }

        /* FACTIONS */
        .factions-container { display: flex; gap: 10px; height: 100%; }
        .faction-col { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 200px; }
        .faction-header { 
            text-align: center; padding: 5px; font-size: 24px; border-bottom: 2px solid #333; margin-bottom: 5px;
        }
        .fac-villager { color: #81c784; border-color: #2e7d32; }
        .fac-wolf { color: #ff8a80; border-color: #c62828; }
        .fac-neutral { color: #ce93d8; border-color: #ad1457; }

        /* ROLE CARD */
        .role-card { 
            display: flex; align-items: center; background: #161616; border: 2px solid #333; 
            padding: 5px; transition: 0.1s;
        }
        .role-card:hover { border-color: #fff; background: #222; }
        .role-icon { width: 40px; height: 40px; border: 2px solid #555; margin-right: 10px; image-rendering: pixelated; }
        .role-info { flex: 1; font-size: 22px; }
        .role-input { 
            width: 40px; background: #000; border: 2px solid #444; color: #fff; 
            text-align: center; font-family: 'VT323', monospace; font-size: 22px;
        }

        /* CONTROLS */
        .control-bar { 
            margin-top: 10px; padding: 10px 20px; background: #111; border-top: 2px solid #333; 
            display: flex; gap: 20px; align-items: center; justify-content: space-between;
        }
        .counter-box { font-size: 24px; color: #aaa; }
        .counter-num { color: #fff; font-weight: bold; }
        
        .btn-main { 
            padding: 5px 20px; font-weight: normal; border: 2px solid #000; 
            cursor: pointer; font-family: 'VT323', monospace; font-size: 24px; 
            box-shadow: 3px 3px 0 #000;
        }
        .btn-start { background: #2e7d32; color: white; }
        .btn-start:hover { background: #43a047; transform: translate(-2px, -2px); }
        .btn-start:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        .btn-skip { background: #ff8f00; color: #000; }
        .btn-skip:hover { background: #ffb300; transform: translate(-2px, -2px); }

        /* LOG */
        #log-console { 
            flex: 1; font-size: 18px; padding: 10px; overflow-y: auto; color: #ccc; 
            line-height: 1.2;
        }
        
        /* PREVIEW BOX */
        #role-preview { 
            height: 250px; border: 2px solid #0f0; background: #050505; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; text-align: center; margin-bottom: 10px;
        }
        #preview-img { height: 120px; width: auto; display: none; border: 4px solid #fcd34d; margin-bottom: 10px; image-rendering: pixelated; }
        #preview-name { font-size: 30px; color: #fcd34d; margin-bottom: 5px; }
        #preview-desc { font-size: 20px; color: #ccc; }

        .chat-controls {
            display: flex; gap: 5px; padding: 10px; 
            border-top: 2px solid #333; background: #111;
        }
        #admin-msg-input {
            flex: 1; background: #000; border: 1px solid #444; 
            color: #fff; padding: 5px 10px; font-family: 'VT323', monospace; font-size: 18px;
        }
        .btn-send {
            background: #e94560; color: #fff; border: 1px solid #b00020;
            cursor: pointer; font-family: 'VT323', monospace; font-size: 18px;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="title">GOD MODE <span style="font-size:18px; color:#666">v3.0 (Auto Config)</span></div>
        <div class="room-info" onclick="copyRoomID()" title="Click ƒë·ªÉ copy">
            ID: <span id="room-id-display">...</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="panel-header">
                <span>NG∆Ø·ªúI CH∆†I</span>
                <span id="p-count">0</span>
            </div>
            <div id="player-list"></div>
        </div>

        <div class="main-area">
            <div class="factions-container">
                <div class="faction-col" id="col-villager">
                    <div class="faction-header fac-villager">D√ÇN L√ÄNG</div>
                </div>
                <div class="faction-col" id="col-wolf">
                    <div class="faction-header fac-wolf">PHE S√ìI</div>
                </div>
                <div class="faction-col" id="col-neutral">
                    <div class="faction-header fac-neutral">PHE KH√ÅC</div>
                </div>
            </div>
        </div>

        <div class="sidebar sidebar-right">
            <div id="role-preview">
                <div style="color: #666; font-size: 20px;">[ DI CHU·ªòT V√ÄO ROLE ]</div>
                <img id="preview-img" src="">
                <div id="preview-name"></div>
                <div id="preview-desc"></div>
            </div>
            <div class="panel-header">LOG H·ªÜ TH·ªêNG</div>
            <div id="log-console"></div>
            
            <div class="chat-controls">
                <input type="text" id="admin-msg-input" placeholder="Nh·∫Øn cho c·∫£ l√†ng..." onkeydown="if(event.key==='Enter') sendAdminChat()">
                <button class="btn-send" onclick="sendAdminChat()">G·ª¨I</button>
            </div>
        </div>
    </div>

    <div class="control-bar">
        <div class="counter-box">
            CH·ªåN: <span id="total-roles" class="counter-num">0</span> / <span id="total-players" class="counter-num">0</span>
        </div>
        <div style="display:flex; gap:10px">
            <button id="btn-end-discuss" class="btn-main btn-skip" onclick="endDiscuss()">K·∫æT TH√öC TH·∫¢O LU·∫¨N</button>
            <button id="btn-start" class="btn-main btn-start" onclick="startGame()">B·∫ÆT ƒê·∫¶U GAME</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myRoomId = null;
        let GLOBAL_CONFIG = {}; // L∆∞u config nh·∫≠n t·ª´ server
        let renderTimeout;

        // T·ª± ƒë·ªông t·∫°o ph√≤ng khi v√†o trang
        socket.emit('create_room'); 

        // Nh·∫≠n ID ph√≤ng v√† C·∫•u h√¨nh Role (quan tr·ªçng!)
        socket.on('room_created', data => {
            myRoomId = data.room_id;
            GLOBAL_CONFIG = data.roles_config; // Nh·∫≠n t·ª´ ƒëi·ªÉn config t·ª´ app.py
            document.getElementById('room-id-display').innerText = myRoomId;
            renderRoles();
        });

        // V·∫Ω danh s√°ch Roles d·ª±a tr√™n Config server g·ª≠i xu·ªëng
        function renderRoles() {
            const colVil = document.getElementById('col-villager');
            const colWolf = document.getElementById('col-wolf');
            const colNeu = document.getElementById('col-neutral');

            // Duy·ªát qua t·ª´ng Role ID trong Config
            for (const [rID, info] of Object.entries(GLOBAL_CONFIG)) {
                // X√°c ƒë·ªãnh c·ªôt d·ª±a tr√™n 'team' trong config
                let container;
                if (info.team === 'wolf') container = colWolf;
                else if (info.team === 'neutral') container = colNeu;
                else container = colVil;

                // ID cho input (d√πng ch√≠nh ID Ti·∫øng Anh)
                let inputId = 'role-input-' + rID;
                
                // M·∫∑c ƒë·ªãnh D√¢n L√†ng v√† S√≥i th∆∞·ªùng c√≥ s·∫µn 1 slot
                let defVal = (rID === "Villager" || rID === "Werewolf") ? 1 : 0;

                let html = `
                    <div class="role-card" onmouseenter="showPreview('${rID}')">
                        <img src="/static/assets/${info.img}" class="role-icon">
                        <div class="role-info">${info.name}</div>
                        <input type="number" min="0" value="${defVal}" id="${inputId}" class="role-input" onchange="updateCounter()">
                    </div>
                `;
                container.innerHTML += html;
            }
            updateCounter();
        }

        // Hi·ªÉn th·ªã xem tr∆∞·ªõc ·∫£nh v√† m√¥ t·∫£
        function showPreview(rID) {
            const info = GLOBAL_CONFIG[rID];
            if(info) {
                document.getElementById('role-preview').querySelector('div').style.display = 'none';
                const img = document.getElementById('preview-img');
                img.src = '/static/assets/' + info.img;
                img.style.display = 'block';
                document.getElementById('preview-name').innerText = info.name;
                document.getElementById('preview-desc').innerText = info.desc;
            }
        }

        // ƒê·∫øm t·ªïng s·ªë role ƒë√£ ch·ªçn
        function updateCounter() {
            let total = 0;
            // Duy·ªát qua t·∫•t c·∫£ c√°c role trong config
            for (const rID of Object.keys(GLOBAL_CONFIG)) {
                let el = document.getElementById('role-input-' + rID);
                if(el) total += parseInt(el.value) || 0;
            }

            let pCount = parseInt(document.getElementById('p-count').innerText) || 0;
            const txt = document.getElementById('total-roles');
            txt.innerText = total;
            
            // ƒê·ªïi m√†u n·∫øu kh·ªõp s·ªë l∆∞·ª£ng
            txt.style.color = (total === pCount && total > 0) ? '#4caf50' : '#ff5252';
            document.getElementById('total-players').innerText = pCount;
        }

        // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i (Real-time)
        socket.on('admin_update', data => {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                renderPlayerList(data);
            }, 50);
        });

        function renderPlayerList(data) {
            const list = document.getElementById('player-list');
            const fragment = document.createDocumentFragment();
            document.getElementById('p-count').innerText = data.players.length;
            
            data.players.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-row';
                let statusClass = p.alive ? 'p-alive' : 'p-dead';
                let statusIcon = p.alive ? '‚ù§Ô∏è' : 'üíÄ';
                
                div.innerHTML = `
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between">
                            <span class="${statusClass}" style="font-weight:bold">${p.name}</span>
                            <span>${statusIcon}</span>
                        </div>
                        <div style="font-size:16px; color:#888;">Role: [ ${p.role} ]</div>
                    </div>
                    ${p.alive ? `<span class="kick-x" onclick="kick('${p.sid}')" title="Kick">üö´</span>` : ''}
                `;
                fragment.appendChild(div);
            });
            list.innerHTML = '';
            list.appendChild(fragment);

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Start
            const btnStart = document.getElementById('btn-start');
            if(data.started) {
                btnStart.innerText = "GAME ƒêANG CH·∫†Y...";
                btnStart.disabled = true;
                btnStart.style.opacity = "0.5";
            } else {
                btnStart.innerText = "B·∫ÆT ƒê·∫¶U GAME";
                btnStart.disabled = false;
                btnStart.style.opacity = "1";
            }
            updateCounter();
        }

        // Log h·ªá th·ªëng
        socket.on('server_log', data => {
            const box = document.getElementById('log-console');
            let time = new Date().toLocaleTimeString('vi-VN', {hour12:false});
            box.innerHTML += `<div><span style="color:#555">[${time}]</span> ${data.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        function copyRoomID() {
            navigator.clipboard.writeText(myRoomId);
            alert("ƒê√£ copy ID: " + myRoomId);
        }

        // G·ª≠i l·ªánh b·∫Øt ƒë·∫ßu game
        function startGame() {
            let selectedRoles = {};
            
            // Thu th·∫≠p s·ªë l∆∞·ª£ng t·ª´ c√°c input
            for (const rID of Object.keys(GLOBAL_CONFIG)) {
                let el = document.getElementById('role-input-' + rID);
                if(el) {
                    let val = parseInt(el.value);
                    if(val > 0) selectedRoles[rID] = val; // Key l√† ID ti·∫øng Anh (VD: "Werewolf")
                }
            }
            
            let total = document.getElementById('total-roles').innerText;
            let players = document.getElementById('total-players').innerText;
            
            if(total != players) {
                if(!confirm(`‚ö†Ô∏è C·∫£nh b√°o: S·ªë role (${total}) kh√¥ng kh·ªõp s·ªë ng∆∞·ªùi (${players}).\nServer s·∫Ω t·ª± ƒë·ªông b√π D√¢n L√†ng ho·∫∑c c·∫Øt b·ªõt. Ti·∫øp t·ª•c?`)) return;
            }
            
            // G·ª≠i v·ªÅ server map: { "Werewolf": 2, "Seer": 1, ... }
            socket.emit('admin_start_game', {room_id: myRoomId, roles: selectedRoles});
        }

        function endDiscuss() { socket.emit('admin_end_discussion', {room_id: myRoomId}); }
        function kick(sid) { if(confirm("Kick ng∆∞·ªùi n√†y?")) socket.emit('admin_kick', {room_id: myRoomId, sid: sid}); }

        function sendAdminChat() {
            const inp = document.getElementById('admin-msg-input');
            const msg = inp.value.trim();
            if (msg && myRoomId) {
                socket.emit('admin_chat_msg', {room_id: myRoomId, msg: msg});
                inp.value = ''; // X√≥a √¥ nh·∫≠p sau khi g·ª≠i
            }
        }
    </script>
</body>
</html>