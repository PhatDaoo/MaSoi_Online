<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma S√≥i Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; transition: all 0.3s ease; }
        
        /* --- THAY ƒê·ªîI M√ÄU N·ªÄN T·∫†I ƒê√ÇY --- */
        body { 
            background-color: #030303; /* N·ªÅn g·∫ßn nh∆∞ ƒëen tuy·ªát ƒë·ªëi */
            color: #ccc; 
            font-family: 'VT323', monospace;
            font-size: 22px;
            margin: 0; padding: 10px; text-align: center; 
        }
        
        /* ENTRY SCREEN */
        .screen { 
            max-width: 450px; margin: 5vh auto; padding: 20px; 
            background: #0a0a0a; /* H·ªôp ƒëen nh√°m */
            border-radius: 5px; border: 2px solid #333; /* Vi·ªÅn t·ªëi gi·∫£n h∆°n */
            display: none; box-shadow: 0 0 20px rgba(0,0,0,0.8); 
        }
        .screen.active { display: block; }
        
        input { 
            width: 100%; padding: 10px; margin: 10px 0; 
            background: #000; border: 1px solid #444; color: #fcd34d; 
            border-radius: 0; text-align: center; font-size: 24px; font-family: 'VT323', monospace;
        }
        input::placeholder { color: #444; }
        input:focus { border-color: #e94560; outline: none; }
        
        .btn-confirm { 
            width: 100%; padding: 10px; background: #800; color: white; 
            border: 1px solid #f00; font-size: 28px; cursor: pointer; margin-top: 10px; 
            font-family: 'VT323', monospace; text-transform: uppercase;
        }
        .btn-confirm:hover { background: #a00; box-shadow: 0 0 10px #f00; }

        .card-btn { 
            display: block; width: 100%; padding: 15px; margin: 15px 0; 
            background: #111; border: 1px solid #444; color: #aaa; 
            font-size: 26px; cursor: pointer; text-align: left; font-family: 'VT323', monospace;
        }
        .card-btn:hover { background: #222; border-color: #fff; color: #fff; }

        /* GAME UI LAYOUT */
        #game-ui { max-width: 800px; margin: 0 auto; display: none; }
        
        /* TOP SECTION */
        .game-top { 
            display: flex; gap: 15px; margin-bottom: 15px; 
            background: #0a0a0a; padding: 15px; border: 1px solid #333;
        }
        
        /* CARD */
        .col-card { width: 35%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #role-img { width: 100%; max-width: 140px; border: 2px solid #444; box-shadow: 0 0 15px #000; image-rendering: pixelated; }
        #role-badge { background: #000; padding: 2px 15px; font-size: 24px; margin-top: 10px; border: 1px solid #e94560; color: #e94560; }

        /* ACTIONS */
        .col-actions { width: 65%; display: flex; flex-direction: column; justify-content: center; border-left: 2px dashed #333; padding-left: 20px; }
        #prompt { color: #fcd34d; margin-bottom: 15px; font-size: 26px; min-height: 30px; text-align: left; text-transform: uppercase; letter-spacing: 1px; }
        #actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; }
        
        .btn-act { 
            flex-grow: 1; min-width: 45%; padding: 10px; border: 1px solid #00d4ff; 
            background: #001a22; color: #00d4ff; font-size: 22px; cursor: pointer; 
            font-family: 'VT323', monospace; text-transform: uppercase;
        }
        .btn-act:hover { background: #00d4ff; color: #000; box-shadow: 0 0 10px #00d4ff; }

        /* LOG & HEADER */
        #header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 20px; color: #666; padding: 0 10px; border-bottom: 1px solid #333; }
        
        #log-box { 
            height: 300px; background: #000; border: 1px solid #333;
            overflow-y: auto; padding: 10px; text-align: left; font-size: 20px; margin-bottom: 10px;
            font-family: 'VT323', monospace; color: #888;
        }
        .sys { color: #a80; margin: 5px 0; border-bottom: 1px dashed #222; }
        .chat { margin: 4px 0; color: #ddd; }
        .chat b { color: #00d4ff; }

        /* CHAT INPUT */
        .input-group { display: flex; gap: 5px; }
        #msg { text-align: left; background: #0a0a0a; padding: 10px 15px; font-size: 22px; border: 1px solid #333; color: #fff; }
        #msg:focus { border-color: #666; }
        button.send { background: #111; color: #888; border: 1px solid #333; padding: 0 25px; font-size: 22px; cursor: pointer; font-family: 'VT323', monospace; }
        button.send:hover { background: #222; color: #fff; border-color: #fff; }
    </style>
</head>
<body>

    <div id="screen-entry" class="screen active">
        <h1 style="color:#e94560; letter-spacing: 4px; font-size: 60px; margin: 10px 0; text-shadow: 2px 2px 0 #000;">MA S√ìI ONLINE</h1>
        <button class="card-btn" onclick="window.location.href='/godmode'">üëë T·∫†O PH√íNG (QU·∫¢N TR√í)</button>
        <button class="card-btn" onclick="toLogin()">üê∫ THAM GIA (NG∆Ø·ªúI CH∆†I)</button>
    </div>

    <div id="screen-login" class="screen">
        <h2 style="margin-top:0; font-size: 40px; color: #fcd34d;">THAM GIA</h2>
        <input type="text" id="room-id" placeholder="M√É PH√íNG (VD: A1B2)" style="text-transform:uppercase">
        <input type="text" id="username" placeholder="T√äN HI·ªÇN TH·ªä">
        <button onclick="joinGame()" class="btn-confirm">V√ÄO GAME</button>
        <p onclick="location.reload()" style="cursor:pointer; color:#444; font-size:20px; margin-top:15px; text-decoration:underline;">[ QUAY L·∫†I ]</p>
    </div>

    <div id="game-ui">
        <div id="header-bar">
            <span>PH√íNG: <b id="d-room" style="color:#e94560">...</b> | T√äN: <b id="d-name" style="color:#fff">...</b></span>
            <img id="icon-phase" src="/static/assets/moon.PNG" style="height:30px; display:none; image-rendering: pixelated; filter: grayscale(100%);">
        </div>

        <div class="game-top">
            <div class="col-card">
                <img id="role-img" src="" style="display:none">
                <div id="role-badge">ƒêang ch·ªù...</div>
            </div>
            
            <div class="col-actions">
                <div id="prompt">ƒêang ƒë·ª£i qu·∫£n tr√≤...</div>
                <div id="actions"></div>
            </div>
        </div>

        <div id="log-box"></div>

        <div class="input-group">
            <input type="text" id="msg" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="if(event.key==='Enter') send()">
            <button class="send" onclick="send()">G·ª¨I</button>
        </div>
    </div>

    <script>
        // --- S·ª¨A ƒê·ªîI QUAN TR·ªåNG: T·ª∞ ƒê·ªòNG NH·∫¨N DI·ªÜN IP ---
        const socket = io(window.location.protocol + '//' + window.location.host, {
            transports: ['websocket', 'polling'], // ∆Øu ti√™n websocket
            reconnection: true,             // T·ª± k·∫øt n·ªëi l·∫°i n·∫øu r·ªõt m·∫°ng
            reconnectionAttempts: 5         // Th·ª≠ 5 l·∫ßn
        });
        
        // Debug k·∫øt n·ªëi ƒë·ªÉ bi·∫øt l·ªói
        socket.on('connect_error', (err) => {
            console.log("L·ªói k·∫øt n·ªëi:", err);
            // Hi·ªÉn th·ªã l·ªói l√™n m√†n h√¨nh ƒë·ªÉ d·ªÖ check tr√™n ƒëi·ªán tho·∫°i
            alert("L·ªói k·∫øt n·ªëi Socket: " + err); 
        });
        
        // --- NAVIGATION ---
        function toLogin() {
            hideAllScreens();
            document.getElementById('screen-login').classList.add('active');
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('game-ui').style.display = 'none';
        }

        // --- ACTIONS ---
        function joinGame() {
            const name = document.getElementById('username').value.trim();
            const rid = document.getElementById('room-id').value.trim().toUpperCase();
            
            // T·∫Øt b√†n ph√≠m ·∫£o ngay l·∫≠p t·ª©c
            if (document.activeElement) {
                document.activeElement.blur();
            }

            if(!name || !rid) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!");
            
            // G·ª≠i y√™u c·∫ßu
            socket.emit('join_game', {name: name, room_id: rid});
            
            // Feedback cho ng∆∞·ªùi d√πng bi·∫øt ƒëang x·ª≠ l√Ω (tr√°nh b·∫•m nhi·ªÅu l·∫ßn)
            const btn = document.querySelector('.btn-confirm');
            btn.innerText = "ƒêANG K·∫æT N·ªêI...";
            btn.disabled = true;
        }

        function send() {
            const inp = document.getElementById('msg');
            if(inp.value) { 
                socket.emit('chat_msg', {msg: inp.value}); 
                inp.value = ''; 
                // Tr√™n mobile sau khi g·ª≠i tin nh·∫Øn n√™n gi·ªØ focus ho·∫∑c blur t√πy tr·∫£i nghi·ªám
                inp.focus(); 
            }
        }

        function addLog(msg, type) {
            const box = document.getElementById('log-box');
            box.innerHTML += `<div class="${type}">${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- SOCKET EVENTS ---
        
        socket.on('join_success', data => {
            // 1. Reset n√∫t b·∫•m (ƒë·ªÅ ph√≤ng)
            const btn = document.querySelector('.btn-confirm');
            btn.innerText = "V√ÄO GAME";
            btn.disabled = false;

            // 2. Chuy·ªÉn m√†n h√¨nh (D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o UI mobile k·ªãp render)
            setTimeout(() => {
                hideAllScreens();
                document.getElementById('game-ui').style.display = 'block';
                
                // 3. C·∫≠p nh·∫≠t th√¥ng tin
                document.getElementById('d-room').innerText = data.room_id;
                document.getElementById('d-name').innerText = document.getElementById('username').value;
            }, 100);
        });

        socket.on('server_msg', data => {
            // Reset n√∫t n·∫øu c√≥ l·ªói x·∫£y ra
            if(data.type === 'SYS' && data.payload.includes('‚ùå')) {
                const btn = document.querySelector('.btn-confirm');
                btn.innerText = "V√ÄO GAME";
                btn.disabled = false;
                alert(data.payload);
            }
            else if(data.type === 'SYS') addLog(data.payload, 'sys');
            else if(data.type === 'MSG') addLog(data.payload, 'chat');
            else if(data.type === 'ROLE') {
                document.getElementById('role-badge').innerText = data.payload.role_name;
                let name = data.payload.role_name;
                let imgMap = {
                    "S√≥i": "wolf.PNG", "D√¢n L√†ng": "villager.PNG", "Ti√™n Tri": "seer.PNG", "B·∫£o v·ªá": "protector.PNG",
                    "Th·ª£ sƒÉn": "hunter.PNG", "Ph√π th·ªßy": "witch.PNG", "S√≥i con": "wolf_cub.PNG", "S√≥i ƒë·∫ßu ƒë√†n": "alpha_wolf.PNG"
                };
                // Fallback t√™n ·∫£nh
                let imgFile = imgMap[name] || (name.toLowerCase().replace(/ /g, "_") + ".PNG");
                document.getElementById('role-img').src = `/static/assets/${imgFile}`;
                document.getElementById('role-img').style.display = 'block';
            }
            else if(data.type === 'PHASE') {
                const isDay = data.payload === 'DAY';
                document.body.style.backgroundColor = isDay ? '#1a1a1a' : '#030303';
                const icon = document.getElementById('icon-phase');
                icon.src = isDay ? '/static/assets/sun.PNG' : '/static/assets/moon.PNG';
                icon.style.display = 'inline';
                icon.style.filter = isDay ? 'none' : 'grayscale(100%)';
            }
            else if(data.type === 'INPUT') {
                document.getElementById('prompt').innerText = data.payload.prompt;
                const area = document.getElementById('actions');
                area.innerHTML = '';
                data.payload.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-act';
                    btn.innerText = opt[1];
                    btn.onclick = () => {
                        socket.emit('send_action', {value: opt[0]});
                        area.innerHTML = '';
                        document.getElementById('prompt').innerText = '>>> ƒê√É CH·ªåN <<<';
                    };
                    area.appendChild(btn);
                });
            }
            else if(data.type === 'OVER') {
                alert(`TR√í CH∆†I K·∫æT TH√öC!\n\nChi·∫øn th·∫Øng: ${data.payload.winner}`);
                location.reload();
            }
        });
    </script>
</body>
</html>