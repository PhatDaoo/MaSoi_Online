<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ma S√≥i Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { background-color: #030303; color: #ccc; font-family: 'VT323', monospace; font-size: 20px; margin: 0; padding: 10px; text-align: center; overflow-x: hidden; }
        body.is-dead { filter: grayscale(100%) contrast(1.2); background-color: #111; }
        body.is-dead .ghost-msg { color: #fff !important; background: #000; border: 1px solid #fff; }

        /* OVERLAY */
        #card-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        
        /* CARD STYLING */
        .flip-card {
            background-color: transparent;
            width: 260px; height: 380px;
            perspective: 1000px; cursor: pointer; margin-bottom: 20px;
        }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center; transition: transform 0.8s; transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.1); /* Glow nh·∫π ƒë·ªÉ th·∫•y b√†i trong ƒë√™m */
        }

        /* M·∫∂T SAU (L∆∞ng b√†i) */
        .flip-card-front {
            background: #111; border: 2px solid #555; color: #444;
        }
        .card-back-text { font-size: 50px; opacity: 0.5; } /* Text d·ª± ph√≤ng n·∫øu ·∫£nh l·ªói */

        /* M·∫∂T TR∆Ø·ªöC (Role) */
        .flip-card-back {
            background-color: #000; transform: rotateY(180deg); border: 2px solid #e94560;
        }
        
        .card-back-img, .card-role-img { 
            position: absolute; /* Quan tr·ªçng: tho√°t kh·ªèi d√≤ng ch·∫£y flex */
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß k√≠n khung, c·∫Øt ph·∫ßn th·ª´a */
            z-index: 10; /* ƒê√® l√™n text d·∫•u ? */
            border-radius: 13px; /* Bo g√≥c nh·∫π cho kh·ªõp v·ªõi vi·ªÅn cha (15px - 2px border) */
        }
        
        .tap-hint { margin-top: 15px; color: #fcd34d; animation: blink 1s infinite; font-size: 24px; text-shadow: 0 0 10px #fcd34d; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .minimize-anim { animation: flyToCorner 1s forwards ease-in-out; }
        @keyframes flyToCorner { 100% { transform: translate(-40vw, -40vh) scale(0.1); opacity: 0; } }

        /* UI ELEMENTS */
        .screen { max-width: 450px; margin: 5vh auto; padding: 20px; background: #0a0a0a; border: 2px solid #333; display: none; }
        .screen.active { display: block; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fcd34d; text-align: center; font-size: 22px; font-family: inherit; }
        .btn-confirm { width: 100%; padding: 10px; background: #800; color: white; border: 1px solid #f00; font-size: 24px; cursor: pointer; margin-top: 10px; font-family: inherit; }
        .card-btn { display: block; width: 100%; padding: 15px; margin: 15px 0; background: #111; border: 1px solid #444; color: #aaa; font-size: 24px; cursor: pointer; text-align: left; font-family: inherit; }

        #game-ui { max-width: 800px; margin: 0 auto; display: none; }
        #player-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; padding: 10px; background: #080808; border-bottom: 2px solid #333; }
        .player-seat { background: #222; border: 1px solid #555; padding: 2px 8px; border-radius: 4px; font-size: 18px; }
        .player-seat.dead { color: #444; text-decoration: line-through; border-color: #333; background: #111; }
        
        .game-top { display: flex; gap: 10px; margin-bottom: 15px; background: #0a0a0a; padding: 10px; border: 1px solid #333; }
        .col-card { width: 30%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #role-badge-img { width: 100%; max-width: 100px; border: 2px solid #444; display: none; cursor: pointer; transition: transform 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #role-badge-img:hover { transform: scale(1.05); border-color: #fcd34d; }
        #role-badge-text { font-size: 20px; color: #e94560; margin-top: 5px; }
        
        .col-actions { width: 70%; display: flex; flex-direction: column; justify-content: center; border-left: 1px dashed #333; padding-left: 15px; }
        #prompt { color: #fcd34d; margin-bottom: 10px; font-size: 22px; min-height: 30px; }
        #actions { display: flex; flex-wrap: wrap; gap: 5px; }
        .btn-act { flex-grow: 1; padding: 8px; border: 1px solid #00d4ff; background: #001a22; color: #00d4ff; font-size: 18px; cursor: pointer; font-family: inherit; }

        #header-bar { display: flex; justify-content: space-between; margin-bottom: 5px; color: #666; font-size: 18px; }
        #log-box { height: 50vh; background: #000; border: 1px solid #333; overflow-y: auto; padding: 10px; text-align: left; font-size: 18px; margin-bottom: 10px; color: #888; }
        .sys { color: #a80; border-bottom: 1px dashed #222; padding: 2px 0; }
        .chat { color: #ddd; margin: 2px 0; }
        .wolf-chat { color: #ff4d4d; background: rgba(50,0,0,0.3); border-left: 2px solid #f00; padding-left: 5px; }
        .ghost-msg { color: #aaa; font-style: italic; }
        .input-group { display: flex; gap: 5px; }
        #msg { flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 10px; font-family: inherit; font-size: 20px; }
        .send { background: #222; color: #fff; border: 1px solid #444; width: 80px; font-family: inherit; font-size: 20px; }
    
        #game-over-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px;
        }
        
        .winner-title {
            color: #ffd700; font-size: 50px; margin-bottom: 20px; text-shadow: 0 0 20px #ff0000;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .result-board {
            background: #111; border: 2px solid #555; border-radius: 10px;
            width: 100%; max-width: 600px; padding: 10px;
        }

        .res-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #333;
        }
        .res-row:last-child { border-bottom: none; }
        
        .res-left { display: flex; align-items: center; gap: 10px; }
        .res-avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #777; }
        
        .res-name { font-size: 24px; color: #fff; }
        .res-role { font-size: 18px; color: #aaa; }
        
        .res-status { font-size: 20px; font-weight: bold; }
        .st-alive { color: #4caf50; }
        .st-dead { color: #f44336; text-decoration: line-through; }

        .btn-restart {
            margin-top: 20px; padding: 15px 40px; background: #e94560; color: white;
            border: none; font-size: 24px; cursor: pointer; border-radius: 5px;
            font-family: inherit; box-shadow: 0 0 15px #e94560;
        }
        
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
    </style>
</head>
<body>
    <div id="card-overlay">
        <div class="flip-card" onclick="onCardClick(this)">
            <div class="flip-card-inner" id="card-inner">
                <div class="flip-card-front">
                    <div class="card-back-text">?</div>
                    <img src="/static/assets/card_back.PNG" class="card-back-img" onerror="this.style.display='none'">
                </div>
                <div class="flip-card-back">
                    <img id="reveal-img" class="card-role-img" src="">
                </div>
            </div>
        </div>
        <div class="tap-hint" id="tap-hint">CH·∫†M ƒê·ªÇ L·∫¨T B√ÄI</div>
    </div>

    <div id="screen-entry" class="screen active">
        <h1 style="color:#e94560; font-size: 50px; margin: 0;">MA S√ìI</h1>
        <button class="card-btn" onclick="window.location.href='/godmode'">üëë T·∫†O PH√íNG</button>
        <button class="card-btn" onclick="toLogin()">üê∫ THAM GIA</button>
    </div>

    <div id="screen-login" class="screen">
        <h2 style="color: #fcd34d;">ƒêƒÇNG NH·∫¨P</h2>
        <input type="text" id="room-id" placeholder="M√É PH√íNG" style="text-transform:uppercase">
        <input type="text" id="username" placeholder="T√äN B·∫†N">
        <button onclick="joinGame()" class="btn-confirm">V√ÄO GAME</button>
    </div>

    <div id="game-ui">
        <div id="header-bar">
            <span>P: <b id="d-room" style="color:#e94560">...</b> | <b id="d-name">...</b></span>
            <img id="icon-phase" src="/static/assets/moon.PNG" style="height:24px; filter: grayscale(100%);">
        </div>
        <div id="player-bar"></div>
        <div class="game-top">
            <div class="col-card">
                <img id="role-badge-img" src="" onclick="reviewRole()" title="Xem l·∫°i">
                <div id="role-badge-text">?</div>
            </div>
            <div class="col-actions">
                <div id="prompt">ƒê·ª£i qu·∫£n tr√≤...</div>
                <div id="actions"></div>
            </div>
        </div>
        <div id="log-box"></div>
        <div class="input-group">
            <input type="text" id="msg" placeholder="Chat..." onkeydown="if(event.key==='Enter') send()">
            <button class="send" onclick="send()">G·ª¨I</button>
        </div>
    </div>

    <div id="game-over-screen">
        <div class="winner-title" id="winner-text">CHI·∫æN TH·∫ÆNG</div>
        <div class="result-board" id="result-list">
            </div>
        <button class="btn-restart" onclick="location.reload()">CH∆†I L·∫†I</button>
    </div>

    <script>
        const socket = io({transports: ['websocket', 'polling']});
        let myName = "";
        let GLOBAL_ROLE_CONFIG = {};
        let isInitialReveal = false;

        function toLogin() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-login').classList.add('active');
        }
        function joinGame() {
            const name = document.getElementById('username').value.trim();
            const rid = document.getElementById('room-id').value.trim().toUpperCase();
            if(!name || !rid) return alert("Thi·∫øu th√¥ng tin!");
            myName = name;
            socket.emit('join_game', {name: name, room_id: rid});
            document.querySelector('.btn-confirm').innerText = "ƒêANG K·∫æT N·ªêI...";
        }
        function send() {
            const inp = document.getElementById('msg');
            if(inp.value) { socket.emit('chat_msg', {msg: inp.value}); inp.value = ''; }
        }
        function addLog(msg, type) {
            const box = document.getElementById('log-box');
            box.innerHTML += `<div class="${type}">${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- X·ª¨ L√ù L·∫¨T B√ÄI ---
        function onCardClick(el) {
            if (isInitialReveal) {
                if(el.classList.contains('flipped')) return;
                el.classList.add('flipped');
                document.getElementById('tap-hint').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('card-inner').classList.add('minimize-anim');
                    setTimeout(() => {
                        document.getElementById('card-overlay').style.display = 'none';
                        document.getElementById('card-inner').classList.remove('minimize-anim');
                        el.classList.remove('flipped'); 
                        document.getElementById('role-badge-img').style.display = 'block';
                        isInitialReveal = false;
                    }, 900);
                }, 5000); // 5s thu nh·ªè
            } else {
                document.getElementById('card-overlay').style.display = 'none';
            }
        }
        function reviewRole() {
            if(isInitialReveal) return;
            const overlay = document.getElementById('card-overlay');
            const inner = document.getElementById('card-inner');
            const card = document.querySelector('.flip-card');
            
            inner.classList.remove('minimize-anim');
            card.classList.add('flipped'); // Lu√¥n hi·ªán m·∫∑t ng·ª≠a
            overlay.style.display = 'flex';
            
            const hint = document.getElementById('tap-hint');
            hint.innerText = "CH·∫†M ƒê·ªÇ ƒê√ìNG";
            hint.style.display = 'block';
        }

        // --- SOCKET HANDLERS ---
        socket.on('join_success', data => {
            if(data.roles_config) GLOBAL_ROLE_CONFIG = data.roles_config;
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('d-room').innerText = data.room_id;
            document.getElementById('d-name').innerText = myName;
        });

        socket.on('server_msg', data => {
            if(data.type === 'ROLE') {
                console.log("NH·∫¨N ƒê∆Ø·ª¢C ROLE:", data.payload); // Debug Log
                let rID = data.payload.role_id;
                let conf = GLOBAL_ROLE_CONFIG[rID];
                let rName = conf ? conf.name : "Unknown";
                let imgPath = conf ? `/static/assets/${conf.img}` : "/static/assets/villager.PNG";

                document.getElementById('reveal-img').src = imgPath;
                document.getElementById('role-badge-text').innerText = rName;
                document.getElementById('role-badge-img').src = imgPath;

                // K√≠ch ho·∫°t overlay
                const card = document.querySelector('.flip-card');
                const inner = document.getElementById('card-inner');
                card.classList.remove('flipped');
                inner.classList.remove('minimize-anim');
                document.getElementById('card-overlay').style.display = 'flex';
                document.getElementById('tap-hint').innerText = "CH·∫†M ƒê·ªÇ L·∫¨T B√ÄI";
                document.getElementById('tap-hint').style.display = 'block';
                isInitialReveal = true;
            }
            else if(data.type === 'SYS') {
                if(data.payload.includes('‚ùå')) { alert(data.payload); document.querySelector('.btn-confirm').innerText = "V√ÄO GAME"; }
                else addLog(data.payload, 'sys');
            }
            else if(data.type === 'MSG') {
                let css = 'chat';
                if(data.payload.includes('üê∫')) css = 'wolf-chat';
                else if(data.payload.includes('üì¢')) css = 'last-words';
                else if(data.payload.includes('üëª')) css = 'ghost-msg';
                addLog(data.payload, css);
            }
            else if(data.type === 'SEAT_UPDATE') {
                const bar = document.getElementById('player-bar');
                bar.innerHTML = '';
                let amIDead = false;
                data.payload.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'player-seat' + (p.alive ? '' : ' dead');
                    div.innerText = p.name;
                    bar.appendChild(div);
                    if(p.name === myName && !p.alive) amIDead = true;
                });
                if(amIDead) { document.body.classList.add('is-dead'); document.getElementById('msg').placeholder = "Chat v·ªõi ng∆∞·ªùi ch·∫øt..."; }
                else { document.body.classList.remove('is-dead'); document.getElementById('msg').placeholder = "Chat..."; }
            }
            else if(data.type === 'INPUT') {
                document.getElementById('prompt').innerText = data.payload.prompt;
                const area = document.getElementById('actions');
                area.innerHTML = '';
                data.payload.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-act';
                    btn.innerText = opt[1];
                    btn.onclick = () => {
                        socket.emit('send_action', {value: opt[0]});
                        area.innerHTML = '';
                        document.getElementById('prompt').innerText = '>>> ƒê√É CH·ªåN <<<';
                    };
                    area.appendChild(btn);
                });
            }
            else if(data.type === 'PHASE') {
                const isDay = data.payload === 'DAY';
                document.getElementById('icon-phase').src = isDay ? '/static/assets/sun.PNG' : '/static/assets/moon.PNG';
                if(!document.body.classList.contains('is-dead')) document.body.style.backgroundColor = isDay ? '#1a1a1a' : '#030303';
            }
            else if(data.type === 'OVER') {
                // Hi·ªÉn th·ªã m√†n h√¨nh k·∫øt th√∫c
                document.getElementById('game-over-screen').style.display = 'flex';
                document.getElementById('winner-text').innerText = data.payload.winner;
                
                const list = document.getElementById('result-list');
                list.innerHTML = '';
                
                // Duy·ªát qua danh s√°ch k·∫øt qu·∫£ server g·ª≠i v·ªÅ
                data.payload.results.forEach(p => {
                    // L·∫•y th√¥ng tin Role t·ª´ Config
                    let conf = GLOBAL_ROLE_CONFIG[p.role_id] || {name: p.role_id, img: 'villager.PNG'};
                    let statusHtml = p.alive ? '<span class="st-alive">S·ªêNG</span>' : '<span class="st-dead">CH·∫æT</span>';
                    
                    // Style m√†u t√™n theo phe (S√≥i ƒë·ªè, D√¢n xanh)
                    let nameColor = '#fff';
                    if(p.team === 'Werewolf') nameColor = '#ff5252';
                    else if(p.team === 'Villager') nameColor = '#69f0ae';
                    else nameColor = '#e040fb'; // Neutral

                    let html = `
                        <div class="res-row">
                            <div class="res-left">
                                <img src="/static/assets/${conf.img}" class="res-avatar">
                                <div>
                                    <div class="res-name" style="color:${nameColor}">${p.name}</div>
                                    <div class="res-role">${conf.name}</div>
                                </div>
                            </div>
                            <div class="res-status">${statusHtml}</div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            }
        });
    </script>
</body>
</html>
